# ExtendedChatPalette
## 要件定義
1. システム概要
    - システム名
        「拡張チャットパレット」
    - 開発背景
        ココフォリアの使用中、「特技用管理コマ(強化Lvなど、スキル用の変動パラメータを保持する)」と「メインキャラコマ(HPなど、メインパラメータを保持する)」の2キャラを使用してセッションを行う特殊な事態が発生した。
        その際、攻撃時は特技用管理コマの「武器ダメージ」パラメータを使用するが、回避時はメインキャラコマの「回避技能」パラメータを使用するといった必要があった。
        そのため、普段は特技用管理コマのチャットパレットに、2キャラ両方分のメッセージを一括で登録しておく、といった手法を取った。
        これにより、「特技用管理コマのチャットパレットを開いたまま、発言キャラをメインキャラに設定する」ことで、1つのチャットパレットで2キャラを使い分けることが可能になる。
        それは、「メッセージをクリックして、入力されたチャットを送信ボタンで送信する際は、メインキャラとして発言できる(発言キャラがメインキャラのため)」「メッセージをダブルクリックした際は、特技用管理コマとして発言できる(チャットパレットが特技用管理コマのものであるため)」といった特殊な手法を取ることができるためである。
        しかし、この手法では使い分けられるキャラは2キャラが限界となる。そのため、メッセージとキャラが紐付けられ、1つのチャットパレットで複数キャラのメッセージを管理できるような、拡張チャットパレットが必要だと判断した。
    - 目的
        1つのチャットパレットで複数キャラのメッセージテンプレートを管理することを目的とする。
        ココフォリアのページ内で使用できるような、Chromeの拡張機能として実装する。
    - 利用者
        ココフォリアの一部ユーザーを一応想定している。~~本当は開発者の私のみが利用者となる予定。~~
        PLよりはGM側の使用者が多くなることが予見される。
    - 利用環境
        Google Chromeで稼働するココフォリア。
1. 機能要件
    - 拡張チャットパレット
        キャラが紐付けられたメッセージを管理するチャットパレット。
        とあるチャットパレットを送信すると、チャットパレットに紐付けられたキャラの発言としてメッセージを送信できる。
        優先度：高、必須
    - 拡張チャットパレットの編集機能
        拡張チャットパレットの編集機能。
        優先度：高、必須
    - 部屋別の拡張チャットパレットの保存機能
        拡張チャットパレットを部屋別に保存する機能。
        優先度：高、必須
    - 部屋別の拡張チャットパレットの一覧表示・削除機能
        部屋別に保存した拡張チャットパレットを一覧表示する機能。
        一覧から選んで削除もできる。
        優先度：高、必須
    - プレーンテキストによる拡張チャットパレットの作成
        特定のフォーマットを使用することで、拡張チャットパレットの要件を満たしたデータ形式のデータをプレーンテキストで作成できる機能。
        優先度：高、必須
    - 複数行に渡るメッセージ
        複数行に渡るメッセージをチャットパレットに登録する機能。
        ココフォリアでは1行分のチャットパレットしか作成できない現状を改善する。
        優先度：中、任意
    - 複数のメッセージ
        同じキャラクターの発言として、一度の操作で複数のメッセージを送信する機能。
        優先度：中、任意
    - 発言キャラクター変更
        メッセージは送信せず、発言キャラクターのみ変更を行う機能。
       優先度：中、任意
    - 現在のキャラクターによる発言
        発言キャラクターを指定せず、現在のキャラクターの発言としてメッセージを送信する機能。
        優先度：中、任意
    - チャットパレットの区切り線作成
        チャットパレットのセクションごとに区切るための区切り線を作成・削除する機能。
        優先度：中、任意
    - タブ管理機能
        拡張チャットパレットを複数タブに分割して管理する機能。
        タブ切り替え、タブ追加、タブ名編集、タブ削除の機能を持つ。
        優先度：低、任意
    - 連続回避機能
        ハウスルールでよくあるような、「回避技能の値は、【回避技能】÷【回避回数】となる。(2回目は1/2、3回目は1/3、4回目は1/4といった具合)」というものを管理しやすくなる機能。
        キャラコマに回避回数パラメータを設定するだけで、「回避技能を振る」「回避回数パラメータを増加させる」という2つ分のメッセージを一括で送信できる。
        (ただし、ラウンド終了時に回避回数のリセットメッセージも送る必要がある。)
        優先度：低、任意
2. 非機能要件
    - 一括で複数のメッセージを送信する際は、サーバー負荷軽減のため、1秒弱程度の間隔時間を設定する。
3. インターフェース要件
    - ココフォリアの「マイキャラクター一覧」や「スクリーンパネル一覧」等があるタブバーに「拡張チャットパレット」タブを追加する。
        - 追加された拡張チャットパレットは、従来のチャットパレット同様の仕様である。
            - 可変長の横幅
            - 可変長の高さ
            - 縦方向のスクロールバー
            - 横方向のスクロールバー(横幅に対してチャパレが長いとき)
            - 鉛筆マークボタンで編集画面を開く
        - ただし、従来のチャットパレットとは異なり、拡張チャットパレットには以下の独自要素が追加されている。
            - チャットパレットの区切り
            - タブ切り替え用のタブバー
            - 連続回避メッセージ送信ボタン
            - 回避回数リセットボタン
    - 拡張機能ボタンをクリックすると、部屋毎の拡張チャットパレットの使用容量の一覧を表示する。
        - 部屋へのページ遷移と拡張チャットパレットデータ削除が可能。
    - ユーザーが設定した拡張チャットパレットのデータは、`chrome.storage`APIを使用して保存する。
        - `chrome.storage.sync`を用いて、ユーザーのGoogleアカウントに同期してデータを保存する。
        - データ形式はjson形式で保存する。詳しくは`データ構造`を参照。
4. 制約事項
    - 使用ブラウザ
        使用ブラウザは、Chromeとする。
    - セキュリティポリシー
        ~~そんなものはない。このリポジトリがPublicな時点で察してください。~~
    - 使用技術の指定
        - オブジェクト指向設計(OOD)を用いて開発すること。Typescriptを使用する。
        - テスト駆動開発(TDD)を用いて開発すること。Jestを使用する。
        - UI構築には、Reactを使用する。
        - モジュールバンドラーには、Webpackを使用する。
## デザイン設計
figmaによりデザイン設計を行う。
[詳細はこちら](https://www.figma.com/file/X4XfistYO3DjdywU55b6fk/ExtendedChatPalette?type=design&node-id=0-1&t=BQjfzyXRU74ZhEVq-0)
## ディレクトリ構造
## テキストフォーマット
拡張チャットパレットの作成に必要なフォーマットを、ここに記す。
- \# 名前
    - "\#"の後ろに半角スペース1つ、その後ろに名前、と指定することで、
    発言キャラクターの指定を行う。
    - この行の次以降の行に、発言キャラクターに紐づけられるメッセージを登録する。
    - 次以降の行にメッセージの登録がない場合、動作時は発言キャラクターの変更のみ行い、メッセージの送信はしない。
- \`\`\`メッセージ\`\`\`
    - "\# 名前"の次の行に"\`\`\`"で括ったテキストを配置すると、
    前の行で指定した発言キャラクターの名前に紐づけて、テキストが登録される。
    - 改行された場合、複数行のメッセージとして登録される。
    - 次の行で名前を指定することなく、メッセージが連続して登録された場合、複数のメッセージとして一括で登録される。
    複数のメッセージとして登録されたメッセージを送信すると、一括で複数のメッセージを送信できる。
- \#\#
    - "\#\#"と指定し、この行の次の行以降にメッセージを登録すると、
    現在入力フォームで指定されている発言キャラクターとして、メッセージを送信する動作を登録できる。
- \-\-\-
    - "\-\-\-"と指定することで、拡張チャットパレット表示時にその行に区切り線を作成する。
## データモデル
```bash
└── data/ #object
    └── ${roomId}/ #object[]
        └── ${index}/ #object
            ├── tabName #string
            ├── originText #string
            └── chatPalettes/ #object[]
                └── ${index}/ #object
                    ├── characterName #string|null
                    ├── messages/ #string[]
                    │   └── ${index}
                    └── isBorder #boolean
```
- data
    拡張チャットパレットのデータが格納されるオブジェクト型配列です。
- ${roomId}
    ココフォリアの一意な部屋IDを表す連想配列のキーです。
- ${index}
    配列番号を示すプレースホルダーです。
    実際のデータの配列番号（0、1、2など）に置き換えてください。
- tabName
    拡張チャットパレットのタブ名を表す文字列です。
- originText
    プレーンテキストをjsonデータに変換する前の拡張チャットパレットのデータを表す文字列です。
- chatPalettes
    1つのタブに登録された拡張チャットパレットのデータが格納されるオブジェクト型配列です。
- characterName
    発言キャラクターの指定を表す文字列です。
    null値が入っている場合は、「現在入力フォームに指定されている発言キャラクターの指定をそのまま使用するため、発言キャラクターの指定を行わない」という意味です。
- messages
    メッセージを表す文字列型配列です。
- isBorder
    区切り線のデータかどうかを表す論理型プロパティです。
## クラス設計