# ExtendedChatPalette
## 要件定義
1. システム概要
    - システム名
        「拡張チャットパレット」
    - 開発背景
        ココフォリアの使用中、「特技用管理コマ(強化Lvなど、スキル用の変動パラメータを保持する)」と「メインキャラコマ(HPなど、メインパラメータを保持する)」の2キャラを使用してセッションを行う特殊な事態が発生した。
        その際、攻撃時は特技用管理コマの「武器ダメージ」パラメータを使用するが、回避時はメインキャラコマの「回避技能」パラメータを使用するといった必要があった。
        そのため、普段は特技用管理コマのチャットパレットに、2キャラ両方分のメッセージを一括で登録しておく、といった手法を取った。
        これにより、「特技用管理コマのチャットパレットを開いたまま、発言キャラをメインキャラに設定する」ことで、1つのチャットパレットで2キャラを使い分けることが可能になる。
        それは、「メッセージをクリックして、入力されたチャットを送信ボタンで送信する際は、メインキャラとして発言できる(発言キャラがメインキャラのため)」「メッセージをダブルクリックした際は、特技用管理コマとして発言できる(チャットパレットが特技用管理コマのものであるため)」といった特殊な手法を取ることができるためである。
        しかし、この手法では使い分けられるキャラは2キャラが限界となる。そのため、メッセージとキャラが紐付けられ、1つのチャットパレットで複数キャラのメッセージを管理できるような、拡張チャットパレットが必要だと判断した。
    - 目的
        1つのチャットパレットで複数キャラのメッセージテンプレートを管理することを目的とする。
        ココフォリアのページ内で使用できるような、Chromeの拡張機能として実装する。
    - 利用者
        ココフォリアの一部ユーザーを一応想定している。~~本当は開発者の私のみが利用者となる予定。~~
        PLよりはGM側の使用者が多くなることが予見される。
    - 利用環境
        Google Chromeで稼働するココフォリア。
1. 機能要件
    - 拡張チャットパレット
        キャラが紐付けられたメッセージを管理するチャットパレット。
        とあるチャットパレットを送信すると、チャットパレットに紐付けられたキャラの発言としてメッセージを送信できる。
        優先度：高、必須
    - 拡張チャットパレットの編集機能
        拡張チャットパレットの編集機能。
        優先度：高、必須
    - 部屋別の拡張チャットパレットの保存機能
        拡張チャットパレットを部屋別に保存する機能。
        優先度：高、必須
    - 部屋別の拡張チャットパレットの一覧表示・削除機能
        部屋別に保存した拡張チャットパレットを一覧表示する機能。
        一覧から選んで削除もできる。
        優先度：高、必須
    - プレーンテキストによる拡張チャットパレットの作成
        特定のフォーマットを使用することで、拡張チャットパレットの要件を満たしたデータ形式のデータをプレーンテキストで作成できる機能。
        優先度：高、必須
    - 複数行に渡るメッセージ
        複数行に渡るメッセージをチャットパレットに登録する機能。
        ココフォリアでは1行分のチャットパレットしか作成できない現状を改善する。
        優先度：中、任意
    - 複数のメッセージ
        同じキャラクターの発言として、一度の操作で複数のメッセージを送信する機能。
        優先度：中、任意
    - 発言キャラクター変更
        メッセージは送信せず、発言キャラクターのみ変更を行う機能。
       優先度：中、任意
    - 現在のキャラクターによる発言
        発言キャラクターを指定せず、現在のキャラクターの発言としてメッセージを送信する機能。
        優先度：中、任意
    - チャットパレットの区切り線作成
        チャットパレットのセクションごとに区切るための区切り線を作成・削除する機能。
        優先度：中、任意
    - タブ管理機能
        拡張チャットパレットを複数タブに分割して管理する機能。
        タブ切り替え、タブ追加、タブ名編集、タブ削除の機能を持つ。
        優先度：低、任意
    - 拡張回避機能
        ハウスルールでよくあるような、「回避技能の値は、【回避技能】÷【回避回数】となる。(2回目は1/2、3回目は1/3、4回目は1/4といった具合)」というものを管理しやすくなる機能。
        キャラコマに回避回数パラメータを設定するだけで、「回避技能を振る」「回避回数パラメータを増加させる」という2つ分のメッセージを一括で送信できる。
        (ただし、ラウンド終了時に回避回数のリセットメッセージも送る必要がある。)
        優先度：低、任意
2. 非機能要件
    - 一括で複数のメッセージを送信する際は、サーバー負荷軽減のため、1秒弱程度の間隔時間を設定する。
3. インターフェース要件
    - ココフォリアの「マイキャラクター一覧」や「スクリーンパネル一覧」等があるタブバーに「拡張チャットパレット」タブを追加する。
        - 追加された拡張チャットパレットは、従来のチャットパレット同様の仕様である。
            - 可変長の横幅
            - 可変長の高さ
            - 縦方向のスクロールバー
            - 横方向のスクロールバー(横幅に対してチャパレが長いとき)
            - 鉛筆マークボタンで編集画面を開く
        - ただし、従来のチャットパレットとは異なり、拡張チャットパレットには以下の独自要素が追加されている。
            - チャットパレットの区切り
            - タブ切り替え用のタブバー
            - 拡張回避メッセージ送信ボタン
            - 回避回数リセットボタン
    - 拡張機能ボタンをクリックすると、部屋毎の拡張チャットパレットの使用容量の一覧を表示する。
        - 部屋へのページ遷移と拡張チャットパレットデータ削除が可能。
    - ユーザーが設定した拡張チャットパレットのデータは、`chrome.storage`APIを使用して保存する。
        - `chrome.storage.local`を用いて、ユーザーのローカルストレージにデータを保存する。
        - データ形式はjson形式で保存する。詳しくは`データ構造`を参照。
4. 制約事項
    - 使用ブラウザ
        使用ブラウザは、Chromeとする。
    - 使用技術の指定
        - 設計には、コンポーネント指向、ウォーターフォール開発を採用する。
        - 開発言語には、Typescriptを使用する。
        - UI構築には、Reactを使用する。
        - モジュールバンドラーには、Webpackを使用する。
## デザイン設計
figmaによりデザイン設計を行う。
[詳細はこちら](https://www.figma.com/file/X4XfistYO3DjdywU55b6fk/ExtendedChatPalette?type=design&node-id=0-1&t=BQjfzyXRU74ZhEVq-0)
## 詳細仕様
### 拡張チャットパレット
- `chrome.storage.local`を用いて実装しているため、端末同士でデータを同期させることはできない。
- タブ数が横幅に収まりきらないときは、横スクロールバーを表示する。
#### 拡張チャットパレット(閲覧)
- キャラ名は横幅2～3文字くらいまで納めて、入りきらない部分は…で表示する
- ドラッグで縦横移動が可能
- 縦幅と横幅はドラッグで変更可能(最小サイズは指定される)
- 収まりきらない長さのメッセージは、横スクロールバーを表示する
- メッセージ数が収まりきらない場合は、縦スクロールバーを表示する
#### 拡張チャットパレット(編集)
- ×ボタンをクリックするとテキストを保存して拡張チャットパレットを閉じる。
- 拡張チャットパレット以外の場所をクリックするとテキストを保存せずに拡張チャットパレットを閉じる。
- ×ボタンを押した時点でその部屋用のデータを作成する。
- タブを追加したり、タブ名を編集したりできる。
- ×ボタンを押してデータを保存すると、部屋名を取得し、部屋IDに紐づけてデータベースに保存する。
- ×ボタンを押してデータを保存すると、プレーンテキストをオブジェクトに変換したものも保存する。
### 拡張機能ボタン
- 拡張機能ボタンをクリックすると、部屋ごとに保存された拡張チャットパレットのデータを一覧で表示できる。
- それぞれ部屋ごとに拡張チャットパレットのデータを削除できる。
- ルームIDをクリックすると、ルームIDのリンク先となるココフォリアの部屋に遷移できる。
- 拡張チャットパレットを保存したときに取得したルーム名が、ルームIDに紐づけて表示される。
- 拡張回避ボタンの表示/非表示を切り替えられる。
## ディレクトリ構造
## テキストフォーマット
拡張チャットパレットの作成に必要なフォーマットを、ここに記す。
- \# 名前
    - "\#"の後ろに半角スペース1つ、その後ろに名前、と指定することで、
    発言キャラクターの指定を行う。
    - この行の次以降の行に、発言キャラクターに紐づけられるメッセージを登録する。
    - 次以降の行にメッセージの登録がない場合、動作時は発言キャラクターの変更のみ行い、メッセージの送信はしない。
- \`\`\`メッセージ\`\`\`
    - "\# 名前"の次の行に"\`\`\`"で括ったテキストを配置すると、
    前の行で指定した発言キャラクターの名前に紐づけて、テキストが登録される。
    - 改行された場合、複数行のメッセージとして登録される。
    - 次の行で名前を指定することなく、メッセージが連続して登録された場合、複数のメッセージとして一括で登録される。
    複数のメッセージとして登録されたメッセージを送信すると、一括で複数のメッセージを送信できる。
- \#\#
    - "\#\#"と指定し、この行の次の行以降にメッセージを登録すると、
    現在入力フォームで指定されている発言キャラクターとして、メッセージを送信する動作を登録できる。
- \-\-\-
    - "\-\-\-"と指定することで、拡張チャットパレット表示時にその行に区切り線を作成する。
## データモデル
```bash
├── settings/ #object
│   └── enableExDodge #boolean
└── data/ #object
    └── ${roomId}/ #object
        ├── roomName #string
        └── tabs #object[]
            └── ${index}/ #object
                ├── tabName #string
                ├── originText #string
                └── chatPalettes/ #object[]
                    └── ${index}/ #object
                        ├── characterName #string|null
                        ├── messages/ #string[]
                        │   └── ${index}
                        └── isBorder #boolean
```
- settings
    拡張チャットパレットの設定データが格納されるオブジェクトです。
- enableExDodge
    拡張回避用ボタンを表示するかどうかを表す論理型プロパティです。
- data
    拡張チャットパレットのデータが格納されるオブジェクトです。
- ${roomId}
    ココフォリアの一意な部屋IDを表す連想配列のキーです。
- roomName
    部屋IDに対応する部屋名を表す文字列です。
    拡張チャットパレット編集時に自動で部屋名を取得します。
- tabs
    拡張チャットパレットのタブ情報をタブごとに保管するオブジェクト型配列です。
- ${index}
    配列番号を示すプレースホルダーです。
    実際のデータの配列番号（0、1、2など）に置き換えてください。
- tabName
    拡張チャットパレットのタブ名を表す文字列です。
- originText
    プレーンテキストをjsonデータに変換する前の拡張チャットパレットのデータを表す文字列です。
- chatPalettes
    1つのタブに登録された拡張チャットパレットのデータが格納されるオブジェクト型配列です。
- characterName
    発言キャラクターの指定を表す文字列です。
    null値が入っている場合は、「現在入力フォームに指定されている発言キャラクターの指定をそのまま使用するため、発言キャラクターの指定を行わない」という意味です。
- messages
    メッセージを表す文字列型配列です。
- isBorder
    区切り線のデータかどうかを表す論理型プロパティです。
## コンポーネント設計
### 拡張チャットパレット画面
#### コンポーネント一覧
- ExChatPaletteView (拡張チャットパレット)
    - HeaderView (チャットパレットのヘッダー)
    - TabBarView (タブ切り替え用のタブバー)
        - TabView (タブ切り替え用のタブ)
    - ChatPaletteList (チャットパレットのリスト)
        - ChatPaletteItem (チャットパレットのアイテム)
    - OptionsView (チャットパレットのオプション)
- ExChatPaletteEdit (チャットパレットの編集画面)
    - HeaderEdit (チャットパレットのヘッダー)
    - EditHelpPopup (ヘルプポップアップ)
    - TabBarEdit (タブ切り替え用のタブバー)
        - TabEdit (タブ切り替え用のタブ)
    - ChatPaletteEditor (チャットパレットの編集画面のテキスト入力欄)
- ExChatPaletteButton (アクセス用拡張チャットパレットボタン)
- HamburgerListTab (アクセス用拡張チャットパレット欄)
#### コンポーネントの説明
- ExChatPaletteView: 拡張チャットパレットの閲覧用メインコンポーネントで、タブ切り替えやチャットパレットの一覧などを管理します。
- HeaderView: 拡張チャットパレットのヘッダーを表し、編集画面への遷移やページを閉じる機能などを管理します。
- TabBarView: タブ切り替え用のタブバーを表し、複数のタブを含みます。
- TabView: タブ切り替え用のタブを表し、タブの切り替えなどを行います。
- ChatPaletteList: チャットパレットのリストを表し、複数のアイテムを含みます。
- ChatPaletteItem: チャットパレットのアイテムを表し、各メッセージを表示・編集・送信できます。
- OptionsView: チャットパレットのオプションを表示し、拡張回避機能などの操作を行います。
- ExChatPaletteEdit: 拡張チャットパレットの編集用メインコンポーネントで、タブの編集やチャットパレットの編集などを管理します。
- HeaderEdit: 拡張チャットパレットのヘッダーを表し、閲覧画面への遷移や拡張チャットパレットの記法に対するヘルプのポップアップを表示する機能などを管理します。
- EditHelpPopup: 拡張チャットパレットの記法に対するヘルプを表すポップアップです。
- TabBarEdit: タブ切り替え用のタブバーを表し、複数のタブを含みます。
- TabEdit: タブ切り替え用のタブを表し、タブの切り替えやタブ編集用のポップアップの表示などを行います。
- TabEditPopup: タブ編集用のポップアップを表し、タブ名の変更、タブの追加や削除などを行います
- ChatPaletteEditor: チャットパレットの編集画面のテキスト入力欄を表し、プレーンテキストによる拡張チャットパレットの入力を受け付けます。
- ExChatPaletteButton: ココフォリアのボタン欄に追加する「拡張チャットパレット」ボタンです。
- HamburgerListTab: ココフォリアのハンガーガーリストに追加する「拡張チャットパレット」欄です。
### 拡張機能のポップアップ画面
#### コンポーネント一覧
- RoomChatPalettes (部屋別の拡張チャットパレットの一覧)
    - RoomChatPaletteItem (部屋別の拡張チャットパレットの項目)
#### コンポーネントの説明
- RoomChatPalettes: 部屋別の拡張チャットパレットの一覧を表示し、削除などの操作を行います。
- RoomChatPaletteItem: 部屋別の拡張チャットパレットの項目を表し、削除ボタンなどを含みます。
## 開発に必要なモジュール等
```
npm init -y
npm install typescript @types/node --save-dev
tsc --init
npm install webpack ts-loader @webpack-cli/generators
npm install css-loader sass-loader sass mini-css-extract-plugin webpack-fix-style-only-entries --save-dev
npm i -S react react-dom @types/react @types/react-dom
npm install --save-dev @types/chrome
npm install @mui/material @emotion/react @emotion/styled
```